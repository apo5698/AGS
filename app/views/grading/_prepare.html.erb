<div class="row mb-4">
  <div class="col-auto" style="min-width: 400px">
    <%= form_for :upload, url: {action: 'upload'} do |f| %>
      <div class="form-group">
        <div class="input-group">
          <div class="custom-file">
            <%= f.file_field 'file', class: 'custom-file-input', multiple: true %>
            <%= f.label :file, 'Select files', class: 'custom-file-label' %>
          </div>
          <div class="input-group-append">
            <%= f.submit 'Upload', class: 'input-group-text' %>
          </div>
        </div>
      </div>
      <!-- Modal -->
      <div class="modal fade" id="filename-warning" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Filename warning</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true" id="discard">
                  <i class="fas fa-times"></i>
                </span>
              </button>
            </div>
            <div class="modal-body">
              <div id="actual">
                Filename <code></code> may not be a valid submission zip file.
              </div>
              <div id="expected">
                Expected:
                <code>[Course] ([Section]) [Semester] [Year]-[AssignmentName]-[MoodleSubmissionId].zip</code>
              </div>
              <br/>
              Proceed to upload?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal" id="discard">Discard</button>
              <%= f.submit 'Upload', class: 'btn btn-primary' %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
<div class="row mb-4">
  <div class="col-auto" style="min-width: 400px">
    <h3>Uploaded files</h3>
    <% uploaded_files = Dir[@upload_root.join('**', '*')].select { |e| File.file?(e) } %>
    <% if uploaded_files.empty? %>
      None
    <% else %>
      <%= form_for :delete_upload, url: {action: 'delete_upload'} do |f| %>
        <div class="form-group">
          <ul class="list-group code">
            <% uploaded_files.sort.each do |filepath| %>
              <li class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <%= filename = filepath.gsub(@user_root.to_s, '') %>
                <div class="custom-control custom-checkbox">
                  <%= f.check_box :"#{filename}", class: 'custom-control-input' %>
                  <%= f.label :"#{filename}", 0.chr, class: "custom-control-label" %>
                </div>
              </li>
            <% end %>
          </ul>
        </div>
        <div class="float-left">
          <button type="button" class="btn btn-secondary" id="toggle-all">Select/Deselect all</button>
        </div>
        <div class="form-group float-right">
          <%= f.submit 'Delete', class: 'btn btn-outline-primary' %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
<script>
  let uploadFileInput = $('input:file');
  uploadFileInput.on('change', () => {
    let filename = uploadFileInput.val().replace('C:\\fakepath\\', '');
    const moodleFilenamePattern = /(\w+\s\d+\s\(\d+\)\s\w+\s\d+-\w+\s*\d+-\d+\.zip|Grades-\w+\s\d+\s\(\d+\)\s\w+\s\d+-\w+\s\d+-\d+.csv)/;
    if (!filename.match(moodleFilenamePattern) && filename.length !== 0) {
      $('.modal-body #actual code').html(filename);
      $('#filename-warning').modal();
      // Clear uploaded file
      $('#discard, button#discard').on('click', () => {
        uploadFileInput.val(null);
        uploadFileInput.next().text('Choose a zip or file');
      });
    }
  });

  // Disable sessionStorage on this page
  sessionStorage.clear();
</script>